"use strict";(self.webpackChunkjava_note_vuepress2=self.webpackChunkjava_note_vuepress2||[]).push([[1033],{67934:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-3d51e450",path:"/shiro/01-Shiro-%E5%9F%BA%E7%A1%80.html",title:"Shiro 基础",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"简介",slug:"简介",children:[]},{level:2,title:"基本概念",slug:"基本概念",children:[]},{level:2,title:"Shiro 权限认证 API",slug:"shiro-权限认证-api",children:[{level:3,title:"角色（Role）",slug:"角色-role",children:[]},{level:3,title:"Shiro 中检测角色和权限的方法",slug:"shiro-中检测角色和权限的方法",children:[]}]},{level:2,title:"Shiro 内置的 IniRealm（了解、自学）",slug:"shiro-内置的-inirealm-了解、自学",children:[]},{level:2,title:"Shiro 内置的 JdbcRealm",slug:"shiro-内置的-jdbcrealm",children:[{level:3,title:"自定义 SQL 语句（了解） {docsify-ignore}",slug:"自定义-sql-语句-了解-docsify-ignore",children:[]}]}],filePathRelative:"shiro/01-Shiro-基础.md",git:{updatedTime:1629711344e3,contributors:[{name:"hemiao",email:"hemiao3000@126.com",commits:1}]}}},61798:(n,s,a)=>{a.r(s),a.d(s,{default:()=>t});const p=(0,a(66252).uE)('<h1 id="shiro-基础" tabindex="-1"><a class="header-anchor" href="#shiro-基础" aria-hidden="true">#</a> Shiro 基础</h1><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><p>Shiro 是 apache 基金会旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。使用 shiro 就可以非常快速的完成认证、授权等功能的开发，降低系统成本。</p><ul><li><p>整体架构</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro_3.png" alt=""></p><ul><li>上面 Subject 是操作用户</li><li>下面 Security Manager 是 Shiro 的核心</li><li>Authenticator 认证器，管理登录和登出</li><li>Authorizer 授权器赋予主体 Subject 有哪些权限</li><li>Session Manager 是 session 管理器</li><li>Session DAO 提供对 Session 的 crud 操作</li><li>Cache Manager 是缓存管理器</li><li>Realms 是 shiro 和数据库之间的桥梁，shiro 获取认证信息和权限数据就是通过 realms 获取</li><li>Cryptography 是用于加密</li></ul></li><li><p>Shiro 认证过程</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro_5.png" alt=""></p><p>先创建 SecurityManager 对象，然后主体会提交认证请求到 SecurityManager，SecurityManager 使用 Authenticator 做认证，认证时要通过 Realm 获取认证数据做最终的认证。</p></li><li><p>Shiro 授权过程</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro_6.png" alt=""></p><p>先创建 SecurityManager 对象，然后主体会提交认证请求到 SecurityManager，SecurityManager 使用 Authorizer 做授权，认证时要通过 Realm 获取认证数据做最终的认证。</p></li></ul><hr><p>权限管理实现对用户访问系统的控制，按照安全规则或者安全策略『<strong>控制</strong>』用户可以访问而且只能访问自己被『<strong>授权</strong>』的资源。</p><p>权限管理包括用户『<strong>身份认证</strong>』和『<strong>授权</strong>』两部分，简称『认证授权』。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。</p><p>如何管控某个用户对某个资源的访问，有两种思路：『基于角色的访问控制』和『基于资源访问控制』两种。</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro_1.png" alt="shiro_1"></p><blockquote><p>通常企业开发中将资源和权限表合并为一张权限表。</p></blockquote><h2 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h2><ul><li><p>pom.xml</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.shiro<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>shiro-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul><p>使用 Shiro 的核心组件在于：<strong>SecurityManager</strong> 。</p><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p>它是 <strong>org.apache.shiro.mgt.SecurityManager</strong> ，而非 java.lang.SecurityManager ，import 的时候不要弄错了。</p><p>如果发现项目代码中的 SecurityManager 无缘无故报错，确认前面是否 import 了正确的包 。</p></div><p>在每一个使用到 Shiro 的项目中，必须存在 <strong>SecurityManager</strong> 对象。创建、配置 <strong>SecurityManager</strong> 对象，是启用 Shiro 的第一步。</p><p>Shiro 提供了多种内置的方式来创建、配置 Shiro 对象<small>（而且还提供了灵活的自定义创建-配置方式）</small>。其中最简便<small>（也是最不可能在实际中使用）</small>的方法是『硬编码』方式。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationTest</span> <span class="token punctuation">{</span>\n\n  <span class="token keyword">private</span> <span class="token class-name">Logger</span> log <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token comment">// 定义一个 realm</span>\n  <span class="token keyword">private</span> <span class="token class-name">SimpleAccountRealm</span> simpleAccountRealm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAccountRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n  <span class="token annotation punctuation">@Before</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    simpleAccountRealm<span class="token punctuation">.</span><span class="token function">addAccount</span><span class="token punctuation">(</span><span class="token string">&quot;tommy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token annotation punctuation">@Test</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token doc-comment comment">/** 1. 构建 SecurityManager 环境 **/</span>\n\n    <span class="token class-name">DefaultSecurityManager</span> defaultSecurityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 『告知』Shiro 在 simpelAccoutnRealm 中找『标准答案』</span>\n    defaultSecurityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>simpleAccountRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 启用 Shiro</span>\n    <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>defaultSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/** 2. 主体提交认证请求 **/</span>\n\n    <span class="token comment">// 导入 shiro 的 org.apache.shiro.subject.Subject;</span>\n    <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// token 是用户要认证的用户数据</span>\n    <span class="token class-name">UsernamePasswordToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token string">&quot;tommy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// shiro 提供是否认证的方法</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;登陆过&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 登入</span>\n    subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;登陆过&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;isAuthenticated: [{}]&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 退出</span>\n    subject<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;isAuthenticated: [{}]&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n\n  <span class="token annotation punctuation">@Test</span>\n  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token comment">// 1.构建 SecurityManager 环境</span>\n    <span class="token class-name">DefaultSecurityManager</span> defaultSecurityManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    defaultSecurityManager<span class="token punctuation">.</span><span class="token function">setRealm</span><span class="token punctuation">(</span>simpleAccountRealm<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 2.主体提交认证请求</span>\n    <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>defaultSecurityManager<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 导入shiro的org.apache.shiro.subject.Subject;</span>\n    <span class="token class-name">Subject</span> subject <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">UsernamePasswordToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordToken</span><span class="token punctuation">(</span><span class="token string">&quot;tommy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;已登陆&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    subject<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;已登陆&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;未登录&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} &#39;admin&#39; 角色&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;有&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} &#39;user&#39; 角色&quot;</span><span class="token punctuation">,</span> subject<span class="token punctuation">.</span><span class="token function">hasRole</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;有&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;没有&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br></div></div><h2 id="shiro-权限认证-api" tabindex="-1"><a class="header-anchor" href="#shiro-权限认证-api" aria-hidden="true">#</a> Shiro 权限认证 API</h2><p>Shiro 中的权限认证<small>（Authorization）</small>也称授权，它解决了『用户能干什么』的问题。</p><p>权限认证，也就是访问控制，即在应用中控制谁能访问哪些资源。在权限认证中，最核心的三个要素是：<strong>权限</strong>，<strong>角色</strong> 和 <strong>用户</strong> ：</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro_2.png" alt="shiro_2"></p><h3 id="角色-role" tabindex="-1"><a class="header-anchor" href="#角色-role" aria-hidden="true">#</a> 角色（Role）</h3><p>角色是权限的集合，而一个用户可以拥有多种角色。</p><p>RBAC（Role Base Access Control）</p><ul><li><p>逻辑上，『角色』是『权限』的集合。</p></li><li><p>一个人能干什么事情，本质上是因为某个角色能干这个事情，而这个人拥有、充当、扮演了这个角色，所以他才能干这个事情。</p></li></ul><h3 id="shiro-中检测角色和权限的方法" tabindex="-1"><a class="header-anchor" href="#shiro-中检测角色和权限的方法" aria-hidden="true">#</a> Shiro 中检测角色和权限的方法</h3><ul><li><p>Subject 用于判断角色的方法有：</p><table><thead><tr><th style="text-align:left;">方法</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">hasRole(String roleName)</td><td style="text-align:left;">判断是否有该角色访问权，<br>返回 boolen</td></tr><tr><td style="text-align:left;">hasRoles(List&lt;String&gt; roleNames)</td><td style="text-align:left;">判断是否有这些这些角色访问权，<br>返回 boolean[]</td></tr><tr><td style="text-align:left;">hasAllRoles(Collection&lt;String&gt; roleNames)</td><td style="text-align:left;">判断是否有这些这些角色访问权，<br>返回 boolean</td></tr><tr><td style="text-align:left;">checkRole(String roleName)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr><tr><td style="text-align:left;">checkRoles(String... roleNames)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr><tr><td style="text-align:left;">checkRoles(Collection&lt;String&gt; roleNames)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr></tbody></table></li><li><p>Subject 用于判断权限的方法有：</p><table><thead><tr><th style="text-align:left;">方法</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;">isPermitted(String perm)</td><td style="text-align:left;">判断是否有该权限，返回 boolen</td></tr><tr><td style="text-align:left;">&gt;isPermitted(List&lt;String&gt; perms)</td><td style="text-align:left;">判断是否有这些这些权限，返回 boolean[]</td></tr><tr><td style="text-align:left;">isPermittedAll(Collection&lt;String&gt; perms)</td><td style="text-align:left;">判断是否有这些这些权限，返回 boolean</td></tr><tr><td style="text-align:left;">checkPermission(String perm)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr><tr><td style="text-align:left;">checkPermissions(String... perms)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr><tr><td style="text-align:left;">checkPermissionsAll(Collection&lt;String&gt; perms)</td><td style="text-align:left;">如果判断失败抛出 AuthorizationException 异常</td></tr></tbody></table></li></ul><h2 id="shiro-内置的-inirealm-了解、自学" tabindex="-1"><a class="header-anchor" href="#shiro-内置的-inirealm-了解、自学" aria-hidden="true">#</a> Shiro 内置的 IniRealm（了解、自学）</h2><p>IniRealm 是 Shiro 内置的一个 Realm，这种模式中，将用户名、密码、角色、权限编写在一个 <code>.ini</code> 文件中，Shiro 查找该文件并从中读取相关信息用以校验当前登录用户的身份和权限。</p><p>当然，<code>.ini</code> 文件有固定的格式上的语法规则。</p><p>在 resources 目录下创建 <code>user.ini</code> 文件。一个典型的简单 ini 配置文件内容类似如下：</p><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 登录用户名，密码，及其角色</span>\n[users]\n<span class="token attr-name">tommy</span><span class="token punctuation">=</span><span class="token attr-value">123,admin,user</span>\n<span class="token attr-name">jerry</span><span class="token punctuation">=</span><span class="token attr-value">123,user</span>\n\n<span class="token comment"># 角色所具有的的权限</span>\n[roles]\n<span class="token attr-name">admin</span><span class="token punctuation">=</span><span class="token attr-value">user:insert,user:delete,user:update</span>\n<span class="token attr-name">user</span><span class="token punctuation">=</span><span class="token attr-value">user:query</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>结合配置文件，创建-配置 SecurityManager 的典型代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">IniRealm</span> realm<span class="token punctuation">;</span> \n\n<span class="token annotation punctuation">@BeforeEach</span> \n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">Ini</span> ini <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ini</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    ini<span class="token punctuation">.</span><span class="token function">loadFromPath</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:user.ini&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    realm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IniRealm</span><span class="token punctuation">(</span>ini<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token annotation punctuation">@Test</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\t<span class="token comment">// 和 SimpleAccoutRealm 中的测试代码一样</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="custom-container warning"><p class="custom-container-title">WARNING</p><p><code>.ini</code> 文件中还可以有更多方面的相关配置，但是由于我们项目中并非使用 IniRealm，所以此处不作更多介绍和验证。</p></div><h2 id="shiro-内置的-jdbcrealm" tabindex="-1"><a class="header-anchor" href="#shiro-内置的-jdbcrealm" aria-hidden="true">#</a> Shiro 内置的 JdbcRealm</h2><p>很显然将用户信息（特别是密码）存在 <code>.ini</code> 这样的文本文件中，也并非合适的做法。更常见也更合理的做法是将相关信息存在数据库中。</p><p>Shiro 内置的 JdbcRealm 就是自动从数据库中读取相关用户信息，并用以校验当前登录用户的密码、身份和权限。</p><p>从 JdbcRealm 的源码中可以看到其默认的数据库的表和表结构：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> DEFAULT_AUTHENTICATION_QUERY <span class="token operator">=</span>\n    <span class="token string">&quot;SELECT password FROM users WHERE username = ?&quot;</span><span class="token punctuation">;</span>\n\n<span class="token class-name">String</span> DEFAULT_SALTED_AUTHENTICATION_QUERY <span class="token operator">=</span>\n    <span class="token string">&quot;SELECT password, password_salt FROM users WHERE username = ?&quot;</span>\n\n<span class="token class-name">String</span> DEFAULT_USER_ROLES_QUERY <span class="token operator">=</span> \n  <span class="token string">&quot;SELECT role_name FROM user_roles WHERE username = ?&quot;</span>\n\n<span class="token class-name">String</span> DEFAULT_PERMISSIONS_QUERY <span class="token operator">=</span> \n  <span class="token string">&quot;SELECT permission FROM roles_permissions WHERE role_name = ?&quot;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>从其默认的 SQL 查询语句来看，默认的表格的结构非常简单，有可能无法满足你的业务逻辑需求。</p></blockquote><p>jdbcRealm 会用到数据库中的三张表：</p><ul><li><p>用户表 users，形如:</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro-jdbcRealm-01.png" alt="shiro-jdbcRealm-01"></p></li><li><p>角色表 user_roles，形如:</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro-jdbcRealm-02.png" alt="shiro-jdbcRealm-02"></p></li><li><p>角色权限表 roles_permissions，形如：</p><p><img src="https://hemiao3000.gitee.io/java-note-img/images/shiro/img/shiro-jdbcRealm-03.png" alt="shiro-jdbcRealm-03"></p></li></ul><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token keyword">off</span><span class="token punctuation">;</span>\n\n<span class="token comment">-- 用户表</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span>\n<span class="token punctuation">(</span>\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span>            <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>username<span class="token punctuation">`</span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>password<span class="token punctuation">`</span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>        <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>password_salt<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>        <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">&#39;tommy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">&#39;jerry&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;123&#39;</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">-- 角色表</span>\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span><span class="token punctuation">;</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span>\n<span class="token punctuation">(</span>\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span>        <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>username<span class="token punctuation">`</span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;tommy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;tommy&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>user_roles<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;jerry&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">-- 权限表</span>\n<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span><span class="token punctuation">;</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span>\n<span class="token punctuation">(</span>\n  <span class="token punctuation">`</span>id<span class="token punctuation">`</span>         <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>role_name<span class="token punctuation">`</span>  <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token punctuation">`</span>permission<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>permission<span class="token punctuation">`</span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user:insert&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user:delete&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;admin&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user:update&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>roles_permissions<span class="token punctuation">`</span> <span class="token keyword">VALUE</span> <span class="token punctuation">(</span><span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user:query&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token keyword">on</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">DruidDataSource</span> dataSource<span class="token punctuation">;</span>\n<span class="token keyword">private</span> <span class="token class-name">JdbcRealm</span> realm<span class="token punctuation">;</span>\n\n<span class="token keyword">static</span> <span class="token punctuation">{</span>\n    dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/shiro?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token annotation punctuation">@Before</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    realm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcRealm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    realm<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    realm<span class="token punctuation">.</span><span class="token function">setPermissionsLookupEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注意此处。设为 ture，不然会验证失败。</span>\n<span class="token punctuation">}</span>\n\n<span class="token annotation punctuation">@Test</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\t<span class="token comment">// 和 SimpleAccountRealm 以及 IniRealm 中的测试代码一样</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面的测试代码中有一个小细节： <code>jdbcRealm.setPermissionsLookupEnabled(true);</code></p><p>这是一个检测权限的开关，jdbcRealm 默认是关闭 check permission 功能的。如果需要调用 <code>subject.checkPermission()</code> 方法检测用户的权限的话，需要将这个功能开关打开。</p><h3 id="自定义-sql-语句-了解-docsify-ignore" tabindex="-1"><a class="header-anchor" href="#自定义-sql-语句-了解-docsify-ignore" aria-hidden="true">#</a> 自定义 SQL 语句<small>（了解）</small> {docsify-ignore}</h3><p>在上面的测试代码中，我们一直使用的是 JdbcRealm 中自带的默认的 SQL 语句查询用户的密码、身份和权限。如果你的数据库中的表因为某些原因无法满足 Shiro 的默认的要求，而是自建的，从而需要手动指定查询 SQL 语句时，让 Shiro 使用你所指定的 SQL 语句，而不是默认的 SQL 语句去查询用户相关的密码、橘色、权限。</p><p>这时需要为 jdbcRealm 手动指定查询语句：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 使用自定义的 sql 验证表中的用户</span>\n<span class="token class-name">String</span> sql <span class="token operator">=</span> <span class="token string">&quot;select `password` from `test_users` where `user_name` = ?&quot;</span><span class="token punctuation">;</span>\n\nrealm<span class="token punctuation">.</span><span class="token function">setAuthenticationQuery</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里有个小矛盾：此时，可能就不会手动指定 SQL 语句，而是干脆直接自定 Realm ，一切按照我们自己写的代码来。</p>',52),t={render:function(n,s){return p}}}}]);