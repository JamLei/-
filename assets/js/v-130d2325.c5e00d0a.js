"use strict";(self.webpackChunkjava_note_vuepress2=self.webpackChunkjava_note_vuepress2||[]).push([[962],{20477:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-130d2325",path:"/docker-install/99-gitea-drone.html",title:"",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[],filePathRelative:"docker-install/99-gitea-drone.md",git:{updatedTime:1629711344e3,contributors:[{name:"hemiao",email:"hemiao3000@126.com",commits:1}]}}},36106:(n,s,a)=>{a.r(s),a.d(s,{default:()=>e});const p=(0,a(66252).uE)('<ul><li><p>gitea 所依赖的 mysql 数据库配置</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n    <span class="token key atrule">gitea</span><span class="token punctuation">:</span>\n        <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n    <span class="token punctuation">...</span>\n\n    <span class="token key atrule">gitea-db</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitea<span class="token punctuation">-</span>db\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=gitea\n            <span class="token punctuation">-</span> MYSQL_USER=gitea\n            <span class="token punctuation">-</span> MYSQL_PASSWORD=gitea\n            <span class="token punctuation">-</span> MYSQL_DATABASE=gitea\n        <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> /home/docker/gitea/mysql<span class="token punctuation">:</span>/var/lib/mysql\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li><li><p>gitea 配置</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n    <span class="token key atrule">gitea</span><span class="token punctuation">:</span>\n        <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n\n    <span class="token punctuation">...</span>\n\n    <span class="token key atrule">gitea-server</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> gitea/gitea<span class="token punctuation">:</span>1.14.1\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitea\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> USER_UID=1000\n            <span class="token punctuation">-</span> USER_GID=1000\n            <span class="token punctuation">-</span> GITEA__database__DB_TYPE=mysql\n            <span class="token punctuation">-</span> GITEA__database__HOST=gitea<span class="token punctuation">-</span>db<span class="token punctuation">:</span><span class="token number">3306</span>\n            <span class="token punctuation">-</span> GITEA__database__NAME=gitea\n            <span class="token punctuation">-</span> GITEA__database__USER=gitea\n            <span class="token punctuation">-</span> GITEA__database__PASSWD=gitea\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> /home/docker/gitea<span class="token punctuation">:</span>/data\n            <span class="token punctuation">-</span> /etc/timezone<span class="token punctuation">:</span>/etc/timezone<span class="token punctuation">:</span>ro\n            <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro\n        <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;3000:3000&quot;</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;222:22&quot;</span>\n        <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea<span class="token punctuation">-</span>db\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>上述配置有几处注意的地方：</p><ol><li><p><code>GITEA__database__HOST=gitea-db:3306</code> 中的 <code>gitea-db</code> 是 gitea 所依赖的 mysql 容器的名字，而 <code>3306</code> 是它的端口。这和上面的 mysql 配置是遥相呼应的。</p></li><li><p>gitea 映射了宿主机的端口，特别是 ssh 端口，未来在使用中，我们配置、使用的应该是宿主的 IP 和端口。</p></li></ol></li><li><p>drone 配置</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">drone-server</span><span class="token punctuation">:</span>\n    <span class="token key atrule">image</span><span class="token punctuation">:</span> drone/drone<span class="token punctuation">:</span><span class="token number">1</span>\n    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> drone_server\n    <span class="token comment"># restart: always</span>\n    <span class="token key atrule">environment</span><span class="token punctuation">:</span> \n        <span class="token key atrule">DRONE_GITEA_SERVER</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.172.0.160<span class="token punctuation">:</span><span class="token number">3000</span>\n        <span class="token key atrule">DRONE_GITEA_CLIENT_ID</span><span class="token punctuation">:</span> 692002a0<span class="token punctuation">-</span>a313<span class="token punctuation">-</span>49ba<span class="token punctuation">-</span>98f8<span class="token punctuation">-</span>d4d430175e8e\n        <span class="token key atrule">DRONE_GITEA_CLIENT_SECRET</span><span class="token punctuation">:</span> LQ_i3hZ9wRq2PzRmY7Y8Un7XRla9B<span class="token punctuation">-</span>NM9BKTEJAhEPI=\n        <span class="token key atrule">DRONE_RPC_SECRET</span><span class="token punctuation">:</span> 397dc393340dd798fb70c6f93736501c\n        <span class="token key atrule">DRONE_SERVER_HOST</span><span class="token punctuation">:</span> 192.172.0.160<span class="token punctuation">:</span><span class="token number">3001</span>\n        <span class="token key atrule">DRONE_SERVER_PROTO</span><span class="token punctuation">:</span> http\n        <span class="token key atrule">DRONE_USER_CREATE</span><span class="token punctuation">:</span> username<span class="token punctuation">:</span>root<span class="token punctuation">,</span>admin<span class="token punctuation">:</span><span class="token boolean important">true</span>\n    <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n        <span class="token punctuation">-</span> <span class="token string">&quot;3001:80&quot;</span>\n    <span class="token key atrule">volumes</span><span class="token punctuation">:</span> \n        <span class="token punctuation">-</span> <span class="token string">&quot;/home/docker/drone:/var/lib/drone&quot;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上述配置中的 <strong>DRONE_GITEA_CLIENT_ID</strong> 和 <strong>DRONE_GITEA_CLIENT_SECRET</strong> 来源于 gitea 的『<strong>已授权的 OAuth2 应用</strong>』，而 <strong>DRONE_RPC_SECRET</strong> 来源于 <code>openssl rand -hex 16</code> 命令的执行结果。</p></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&quot;3&quot;</span>\n\n<span class="token key atrule">networks</span><span class="token punctuation">:</span>\n    <span class="token key atrule">gitea</span><span class="token punctuation">:</span>\n        <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>\n\n<span class="token key atrule">services</span><span class="token punctuation">:</span>\n    <span class="token key atrule">gitea-server</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> gitea/gitea<span class="token punctuation">:</span>1.14.1\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitea\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> USER_UID=1000\n            <span class="token punctuation">-</span> USER_GID=1000\n            <span class="token punctuation">-</span> GITEA__database__DB_TYPE=mysql\n            <span class="token punctuation">-</span> GITEA__database__HOST=gitea<span class="token punctuation">-</span>db<span class="token punctuation">:</span><span class="token number">3306</span>\n            <span class="token punctuation">-</span> GITEA__database__NAME=gitea\n            <span class="token punctuation">-</span> GITEA__database__USER=gitea\n            <span class="token punctuation">-</span> GITEA__database__PASSWD=gitea\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> /home/docker/gitea<span class="token punctuation">:</span>/data\n            <span class="token punctuation">-</span> /etc/timezone<span class="token punctuation">:</span>/etc/timezone<span class="token punctuation">:</span>ro\n            <span class="token punctuation">-</span> /etc/localtime<span class="token punctuation">:</span>/etc/localtime<span class="token punctuation">:</span>ro\n        <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;3000:3000&quot;</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;222:22&quot;</span>\n        <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea<span class="token punctuation">-</span>db\n\n    <span class="token key atrule">gitea-db</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gitea<span class="token punctuation">-</span>db\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=gitea\n            <span class="token punctuation">-</span> MYSQL_USER=gitea\n            <span class="token punctuation">-</span> MYSQL_PASSWORD=gitea\n            <span class="token punctuation">-</span> MYSQL_DATABASE=gitea\n        <span class="token key atrule">networks</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> gitea\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> /home/docker/gitea/mysql<span class="token punctuation">:</span>/var/lib/mysql\n\n    <span class="token key atrule">drone-server</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> drone/drone<span class="token punctuation">:</span><span class="token number">1</span>\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> drone_server\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span> \n            <span class="token key atrule">DRONE_GITEA_SERVER</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.172.0.160<span class="token punctuation">:</span><span class="token number">3000</span>\n            <span class="token key atrule">DRONE_GITEA_CLIENT_ID</span><span class="token punctuation">:</span> 692002a0<span class="token punctuation">-</span>a313<span class="token punctuation">-</span>49ba<span class="token punctuation">-</span>98f8<span class="token punctuation">-</span>d4d430175e8e\n            <span class="token key atrule">DRONE_GITEA_CLIENT_SECRET</span><span class="token punctuation">:</span> LQ_i3hZ9wRq2PzRmY7Y8Un7XRla9B<span class="token punctuation">-</span>NM9BKTEJAhEPI=\n            <span class="token key atrule">DRONE_RPC_SECRET</span><span class="token punctuation">:</span> 397dc393340dd798fb70c6f93736501c\n            <span class="token key atrule">DRONE_SERVER_HOST</span><span class="token punctuation">:</span> 192.172.0.160<span class="token punctuation">:</span><span class="token number">3001</span>\n            <span class="token key atrule">DRONE_SERVER_PROTO</span><span class="token punctuation">:</span> http\n            <span class="token key atrule">DRONE_USER_CREATE</span><span class="token punctuation">:</span> username<span class="token punctuation">:</span>root<span class="token punctuation">,</span>admin<span class="token punctuation">:</span><span class="token boolean important">true</span>\n        <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;3001:80&quot;</span>\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span> \n            <span class="token punctuation">-</span> <span class="token string">&quot;/home/docker/drone:/var/lib/drone&quot;</span>\n\n    <span class="token key atrule">drone-runner</span><span class="token punctuation">:</span>\n        <span class="token key atrule">image</span><span class="token punctuation">:</span> drone/drone<span class="token punctuation">-</span>runner<span class="token punctuation">-</span>docker\n        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> drone_runner\n        <span class="token key atrule">ports</span><span class="token punctuation">:</span>\n            <span class="token punctuation">-</span> <span class="token string">&quot;8484:3000&quot;</span>\n        <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> \n            <span class="token punctuation">-</span> drone<span class="token punctuation">-</span>server\n        <span class="token comment"># restart: always</span>\n        <span class="token key atrule">environment</span><span class="token punctuation">:</span> \n            <span class="token key atrule">DRONE_RPC_PROTO</span><span class="token punctuation">:</span> http\n            <span class="token key atrule">DRONE_RPC_HOST</span><span class="token punctuation">:</span> 192.172.0.160<span class="token punctuation">:</span><span class="token number">3001</span>\n            <span class="token key atrule">DRONE_RPC_SECRET</span><span class="token punctuation">:</span> 397dc393340dd798fb70c6f93736501c\n            <span class="token key atrule">DRONE_RUNNER_CAPACITY</span><span class="token punctuation">:</span> <span class="token number">5</span>\n            <span class="token key atrule">DRONE_UI_USERNAME</span><span class="token punctuation">:</span> happyxhw\n            <span class="token key atrule">DRONE_UI_PASSWORD</span><span class="token punctuation">:</span> xxxxx\n            <span class="token key atrule">DRONE_RUNNER_NAME</span><span class="token punctuation">:</span> xxxxx\n            <span class="token key atrule">DRONE_RUNNER_LABELS</span><span class="token punctuation">:</span> role<span class="token punctuation">:</span>xxxxx\n        <span class="token key atrule">volumes</span><span class="token punctuation">:</span> \n            <span class="token punctuation">-</span> <span class="token string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div>',2),e={render:function(n,s){return p}}}}]);