"use strict";(self.webpackChunkjava_note_vuepress2=self.webpackChunkjava_note_vuepress2||[]).push([[1078],{66076:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-4bbc91a5",path:"/other/02-JWT.html",title:"JWT（JSON Web Token）",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"1. Session 的弊病和 JWT 的起源",slug:"_1-session-的弊病和-jwt-的起源",children:[]},{level:2,title:"2. JWT 的组成",slug:"_2-jwt-的组成",children:[{level:3,title:"2.1 头部（Header）",slug:"_2-1-头部-header",children:[]},{level:3,title:"2.2 荷载（Payload）部分",slug:"_2-2-荷载-payload-部分",children:[]},{level:3,title:"2.3 签名（Signature）部分",slug:"_2-3-签名-signature-部分",children:[]}]},{level:2,title:"3. JWT 的安全性和注意事项",slug:"_3-jwt-的安全性和注意事项",children:[]},{level:2,title:"4. Java 操作 JWT",slug:"_4-java-操作-jwt",children:[]},{level:2,title:"5. JWT Token 使用技巧",slug:"_5-jwt-token-使用技巧",children:[]}],filePathRelative:"other/02-JWT.md",git:{updatedTime:1629711344e3,contributors:[{name:"hemiao",email:"hemiao3000@126.com",commits:1}]}}},86610:(n,s,a)=>{a.r(s),a.d(s,{default:()=>t});const p=(0,a(66252).uE)('<h1 id="jwt-json-web-token" tabindex="-1"><a class="header-anchor" href="#jwt-json-web-token" aria-hidden="true">#</a> JWT（JSON Web Token）</h1><p>JWT<small>（Json web token）</small>，是为了在网络应用环境声明而执行的一种基于 JSON 的开放标准。</p><h2 id="_1-session-的弊病和-jwt-的起源" tabindex="-1"><a class="header-anchor" href="#_1-session-的弊病和-jwt-的起源" aria-hidden="true">#</a> 1. Session 的弊病和 JWT 的起源</h2><p>『<strong>http 协议本身是无状态的协议</strong>』这是所有问题的起点和关键。在这个前提下，服务器为了弄明白『<strong>这次请求和上次请求是不是同一个人/客户端发来的？</strong>』，在第一次发起请求时，服务器<small>（Tomcat）</small>会创建一个 Session 对象，以表示有人/客户端开始了一次会话，并将这个 Session 对象对应的 id<small>（SessionID）</small>返回给客户端浏览器。在后续的请求中，客户端再发出的请求都需要携带这个 SessionID，以表示当前请求和之前的请求是在同一个会话中。</p><p>传统的 Seesion 认证存在的问题：</p><ol><li><p>用户请求规模大之后增加服务器内存开销；</p></li><li><p>不利于服务端搭建集群。</p></li></ol><p>当然，可以有一些其他的方案<small>（比如使用 Redis 实现 Session 共享）</small>来解决上述 Session 的两个问题，但是 JWT 则是完全提供了另一种不同的思路：『<strong>服务端不负责存储用户信息</strong>』。</p><p>JWT 的认证流程：</p><ol><li><p>客户端发送用户名和密码至服务端进行认证；</p></li><li><p>服务端认证通过后，生成一个具有唯一性标识的字符串：Token；</p></li><li><p>服务端将 Token 发还给客户端，客户端后续的请求都需要带上这个 Token；</p></li><li><p>服务端再次收到客户端请求时，认证这个 Token 是否是自己<small>（服务端）</small>当初生成且未经篡改过的。如果没毛病，那么就认为该用户曾经通过了登陆认证的，本次请求该干嘛干嘛。</p></li></ol><blockquote><p>JWT 和 SessionID 相比表面上看起来好像并没有多大区别，以前服务端回传的是叫 SessionID 的字符串，现在回传的是叫 Token 的字符串，但是它代表着『保存用户信息』这个责任从后端转移到了前端。</p><p>另外，相较于 SessionID 这样的纯 ID 字符串，JWT 的 Token 中多多少少还是能携带一些数据的。</p></blockquote><h2 id="_2-jwt-的组成" tabindex="-1"><a class="header-anchor" href="#_2-jwt-的组成" aria-hidden="true">#</a> 2. JWT 的组成</h2><p>一个 JWT 实际上就是一个字符串，它由三部分组成：头部、荷载 与 签名。</p><p>这个 JWT 的标准形式为『<strong>头部.荷载.签名</strong>』。</p><p>例如：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0b20iLCJleHAiOjE1NjY5MjA4MzIsImlhdCI6MTU2NjkxNzIzMiwianRpIjoiMGM4ODRhNzAtOTdkNy00MTczLTgyYzItMTcyNzA2ZmMyZDU4In0.IKO9rBpLz-u2m2gA1S2gR-8CFn1Z1qs-AZvW55A1SoY\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>需要说明的有 2 点：</p><ol><li><p>JWT 的头部和荷载部分的内容是 JSON，在 JWT 中对于 JSON 的属性<small>（键值对）</small>有一个专门的称呼：Claim 。</p></li><li><p>JWT 是有一套规范的，在规范中定义了一些常见的 Claim 的名称，以方便大家使用。再此之外的 Claim 可以自由命名。</p></li></ol><h3 id="_2-1-头部-header" tabindex="-1"><a class="header-anchor" href="#_2-1-头部-header" aria-hidden="true">#</a> 2.1 头部（Header）</h3><p>JWT 都有一个头部，头部用于描述关于该 JWT 的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个 JSON 对象。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token string">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><strong>type</strong> 和 <strong>alg</strong> 是放在头部的最常见的 2 个 标准 Claim ，通常它俩的值都是固定的。</p><ul><li>type 用来表示当前字符串是什么类型的字符串，毫无疑问，它的值必然就是 <code>JWT</code> ；</li><li>alg 的值表示当前的字符串是使用什么算法加密生成的。通常这个值都是由我们使用的 Java 库来自动填充的<small>（取决于你使用的加密算法）</small>，我们无需专门考虑它的值。</li></ul><p>上述示例表达的含义就是：当前信息是一个 <strong>JWT</strong>，且是被 <strong>HS256</strong> 算法加密过的。</p><p>当然，一个 JWT 的头部信息真正的样子并不是上面这个样子，未来，它会被加密算法加密。上例中的头部内容未来会变成 <code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</code> 。</p><blockquote><p>这个内容其实是被 Base64 编解码算法编码，而不是真正的加密。所以，它可以变反向地解码回来。</p></blockquote><p>除了头部的标准 Claim<small>（不止上述 2 个）</small>，有需要的话，你还可以向头部添加任意的 Claim<small>（它们的名字就是由你自己任意定义了）</small>，这些 Claim 被称为 private Claims 。</p><p>不过，一般情况下，我们不会向头部中添加 private Claims ，即便是要加，也是加到了荷载部分。</p><h3 id="_2-2-荷载-payload-部分" tabindex="-1"><a class="header-anchor" href="#_2-2-荷载-payload-部分" aria-hidden="true">#</a> 2.2 荷载（Payload）部分</h3><p>JWT 的荷载是 JWT 的最重要部分，它就代表着 JWT 的信息内容。JWT 的荷载部分和头部部分一样，其具体内容也是一个 JSON 格式字符串。例如：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n    <span class="token string">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tommy&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jerry&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1627484243323</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;xxx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;yyy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span>\n    <span class="token string">&quot;zzz&quot;</span><span class="token operator">:</span> <span class="token string">&quot;goodbye&quot;</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>和头部一样，荷载部分也有一些标准 Claim ，常见的有：</p><table><thead><tr><th style="text-align:left;">claim</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">iss</td><td style="text-align:left;">jwt 签发者</td></tr><tr><td style="text-align:left;">sub</td><td style="text-align:left;">jw t所面向的用户</td></tr><tr><td style="text-align:left;">aud</td><td style="text-align:left;">接收 jwt 的一方</td></tr><tr><td style="text-align:left;">exp</td><td style="text-align:left;">jwt 的过期时间，这个过期时间必须要大于签发时间</td></tr><tr><td style="text-align:left;">nbf</td><td style="text-align:left;">定义在什么时间之前，该jwt都是不可用的.</td></tr><tr><td style="text-align:left;">iat</td><td style="text-align:left;">jwt 的签发时间</td></tr><tr><td style="text-align:left;">jti</td><td style="text-align:left;">jwt 的唯一身份标识</td></tr></tbody></table><p>除了标准 Claim 你也可以向荷载部分添加任何你对有用的 Claim 。</p><p>和头部一样，上述示例中的荷载内容真正的样子是：</p><pre><code>eyJhdWQiOiJqZXJyeSIsImlzcyI6InRvbW15IiwieXl5Ijoid29ybGQiLCJ4eHgiOiJoZWxsbyIsInp6eiI6Imdvb2RieWUiLCJpYXQiOjE2Mjc0ODQyNDN9\n</code></pre><blockquote><p>和头部部分一样，真正的荷载部分也是经过 Base64 算法编码的。所以，它也是可以反向解码回来的。</p></blockquote><h3 id="_2-3-签名-signature-部分" tabindex="-1"><a class="header-anchor" href="#_2-3-签名-signature-部分" aria-hidden="true">#</a> 2.3 签名（Signature）部分</h3><p>签名部分是用前面的头部和荷载部分的内容生成的。</p><p>将上面的两个编码后的字符串都用句号 <code>.</code> 连接在一起（头部在前，荷载在后），再使用 <strong>HS256</strong> 算法进行加密。</p><p>之所以是 <strong>HS256</strong> 算法，是因为要与头部中所生成的加密算法呼应。<small>当然，你也可以不使用 <strong>HS256</strong> 算法，那么与之对应的你的头部中的加密算法信息也要作响应的调整。</small></p><p>在加密过程中，需要提供一个秘钥（secret）， 例如，以 <code>secret</code> 作为秘钥，上述的头部和荷载部分生成的签名就是：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>uaaPNwE6n5aLztIUcjS7-DiPl9en-MKLaW5i2QkP5vY\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>最终，上例中的整个 JWT 的内容就是：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJqZXJyeSIsImlzcyI6InRvbW15IiwieXl5Ijoid29ybGQiLCJ4eHgiOiJoZWxsbyIsInp6eiI6Imdvb2RieWUiLCJpYXQiOjE2Mjc0ODQyNDN9.uaaPNwE6n5aLztIUcjS7-DiPl9en-MKLaW5i2QkP5vY\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>一旦服务端生成并发回这个 JWT 字符串之后，后续用户的请求就应该带上这个 JWT，以证明自己成功登陆过 ：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>http://.../xxx.do?jwt-token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJqZXJyeSIsImlzcyI6InRvbW15IiwieXl5Ijoid29ybGQiLCJ4eHgiOiJoZWxsbyIsInp6eiI6Imdvb2RieWUiLCJpYXQiOjE2Mjc0ODQyNDN9.uaaPNwE6n5aLztIUcjS7-DiPl9en-MKLaW5i2QkP5vY\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="_3-jwt-的安全性和注意事项" tabindex="-1"><a class="header-anchor" href="#_3-jwt-的安全性和注意事项" aria-hidden="true">#</a> 3. JWT 的安全性和注意事项</h2><p>JWT 的签名部分杜绝了 JWT 被篡改的可能。它从两点实现了这个功能：</p><ol><li><p>被篡改后的荷载部分加上头部后与签名部分对不上（因为签名部分使用之前没改过的内容生成的），这种情况下就是非法的 JWT；</p></li><li><p>前端不知道后端生成 JWT 时使用的是什么秘钥。理论上而言，无法重新生成新的签名部分。</p></li></ol><p>在 JWT 中，『<strong>不应该在载荷里面加入任何敏感的数据</strong>』。在上面的例子中，我们传输的是用户的 User ID 。这个值实际上不是什么敏感内容，一般情况下被知道也是安全的。</p><blockquote><p>理论上来说，只要使用 HTTP 协议都有可能被人拦截/观测到你在网络上所发送的数据。这种情况下，使用什么方案都防不住信息的泄露。这也是现在越来越鼓励使用 https<small>（http+ssl）</small>的原因。</p></blockquote><h2 id="_4-java-操作-jwt" tabindex="-1"><a class="header-anchor" href="#_4-java-操作-jwt" aria-hidden="true">#</a> 4. Java 操作 JWT</h2><p>JWT 是一种理念/方案，它与具体的语言无关。Java 语言中有 <strong><code>jjwt</code></strong> 包来简化我们创建/解析 JWT 。</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.9.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n\n<span class="token comment">&lt;!-- jjwt 依赖于 java-jwt --&gt;</span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.auth0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>java-jwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>代码：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>auth0<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>auth0<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span>algorithms<span class="token punctuation">.</span></span><span class="token class-name">Algorithm</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>jsonwebtoken<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span><span class="token punctuation">;</span>\n\n<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>\n\n\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtil</span> <span class="token punctuation">{</span>\n\n    <span class="token comment">// 生成签名是所使用的秘钥</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> base64EncodedSecretKey<span class="token punctuation">;</span>\n\n    <span class="token comment">// 生成签名的时候所使用的加密算法</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm<span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">(</span><span class="token class-name">String</span> secretKey<span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span> signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>base64EncodedSecretKey <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>signatureAlgorithm <span class="token operator">=</span> signatureAlgorithm<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token doc-comment comment">/**\n     * 生成 JWT Token 字符串\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">iss</span>       签发人名称\n     * <span class="token keyword">@param</span> <span class="token parameter">ttlMillis</span> jwt 过期时间\n     * <span class="token keyword">@param</span> <span class="token parameter">claims</span>    额外添加到荷部分的信息。\n     *                  例如可以添加用户名、用户ID、用户（加密前的）密码等信息\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">String</span> iss<span class="token punctuation">,</span> <span class="token keyword">long</span> ttlMillis<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 签发时间（iat）：荷载部分的标准字段之一</span>\n        <span class="token keyword">long</span> nowMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Date</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>nowMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 下面就是在为payload添加各种标准声明和私有声明了</span>\n        <span class="token class-name">JwtBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token comment">// 荷载部分的非标准字段/附加字段，一般写在标准的字段之前。</span>\n                <span class="token punctuation">.</span><span class="token function">setClaims</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span>\n                <span class="token comment">// JWT ID（jti）：荷载部分的标准字段之一，JWT 的唯一性标识，虽不强求，但尽量确保其唯一性。</span>\n                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n                <span class="token comment">// 签发时间（iat）：荷载部分的标准字段之一，代表这个 JWT 的生成时间。</span>\n                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>\n                <span class="token comment">// 签发人（iss）：荷载部分的标准字段之一，代表这个 JWT 的所有者。通常是 username、userid 这样具有用户代表性的内容。</span>\n                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span>iss<span class="token punctuation">)</span>\n                <span class="token comment">// 设置生成签名的算法和秘钥</span>\n                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">,</span> base64EncodedSecretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlMillis <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">long</span> expMillis <span class="token operator">=</span> nowMillis <span class="token operator">+</span> ttlMillis<span class="token punctuation">;</span>\n            <span class="token class-name">Date</span> exp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 过期时间（exp）：荷载部分的标准字段之一，代表这个 JWT 的有效期。</span>\n            builder<span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n\n    <span class="token doc-comment comment">/**\n     * JWT Token 由 头部 荷载部 和 签名部 三部分组成。签名部分是由加密算法生成，无法反向解密。\n     * 而 头部 和 荷载部分是由 Base64 编码算法生成，是可以反向反编码回原样的。\n     * 这也是为什么不要在 JWT Token 中放敏感数据的原因。\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">jwtToken</span> 加密后的token\n     * <span class="token keyword">@return</span> claims 返回荷载部分的键值对\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">Claims</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwtToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token comment">// 得到 DefaultJwtParser</span>\n        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token comment">// 设置签名的秘钥</span>\n                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span>base64EncodedSecretKey<span class="token punctuation">)</span>\n                <span class="token comment">// 设置需要解析的 jwt</span>\n                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span>\n                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n\n    <span class="token doc-comment comment">/**\n     * 校验 token\n     * 在这里可以使用官方的校验，或，\n     * 自定义校验规则，例如在 token 中携带密码，进行加密处理后和数据库中的加密密码比较。\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">jwtToken</span> 被校验的 jwt Token\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isVerify</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwtToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">Algorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signatureAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">case</span> HS256<span class="token operator">:</span>\n                algorithm <span class="token operator">=</span> <span class="token class-name">Algorithm</span><span class="token punctuation">.</span><span class="token function">HMAC256</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>base64EncodedSecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">break</span><span class="token punctuation">;</span>\n            <span class="token keyword">default</span><span class="token operator">:</span>\n                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;不支持该算法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token class-name">JWTVerifier</span> verifier <span class="token operator">=</span> JWT<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        verifier<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 校验不通过会抛出异常</span>\n\n<span class="token comment">/*\n            // 得到DefaultJwtParser\n            Claims claims = decode(jwtToken);\n\n            if (claims.get(&quot;password&quot;).equals(user.get(&quot;password&quot;))) {\n                return true;\n            }\n*/</span>\n\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">JwtUtil</span> util <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtUtil</span><span class="token punctuation">(</span><span class="token string">&quot;tom&quot;</span><span class="token punctuation">,</span> <span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span>HS256<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">String</span> jwtToken <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;tom&quot;</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token comment">/*\n        util.isVerify(jwtToken);\n        System.out.println(&quot;合法&quot;);\n*/</span>\n\n        util<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br></div></div><h2 id="_5-jwt-token-使用技巧" tabindex="-1"><a class="header-anchor" href="#_5-jwt-token-使用技巧" aria-hidden="true">#</a> 5. JWT Token 使用技巧</h2><ol><li><p>可以将用户的 Http 请求的 UserAgent 信息也放入 JWT 荷载部分。</p><p>这样做的好处是在一定程度上 JWT Token 被盗用。一旦在另一个客户端使用同一个 token 发出 http 请求，http 请求的 UserAgent<small>（大概率）</small>会和前一个客户端不一样。</p><p>按照这个思路，客户端的 IP 信息也可以放入 JWT 荷载部分。</p></li><li><p>服务端不需要考虑客户端将收到的 JWT Token 放哪。</p><p>Cookie 还是 local storage、session storage ？这是客户端<small>（前端开发工程师、IOS/Andriod 客户端开发工程师）</small>考虑的事情。</p></li><li><p>前端向后端传递 JWT token 是，可以放在 http header 里，也可以拼在 url 里，也可以放 cookie 里。</p></li></ol>',58),t={render:function(n,s){return p}}}}]);